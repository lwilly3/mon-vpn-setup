version: "3.8"

# ===========================
# Services
# ===========================
services:
  vpn:
    image: weejewel/wg-easy:latest          # Image Docker officielle wg-easy
    container_name: wg-easy                 # Nom du conteneur
    restart: unless-stopped                  # Redémarrage automatique sauf si stoppé manuellement

    # ---------------------------
    # Ports
    # ---------------------------
    ports:
      - "${WG_PORT}:${WG_PORT}/udp"         # Port UDP pour WireGuard
      - "51821:51821/tcp"                   # Port TCP pour l'interface web

    # ---------------------------
    # Variables d'environnement
    # ---------------------------
    environment:
      - WG_ADMIN_PASSWORD=${WG_ADMIN_PASSWORD} # Mot de passe admin pour l'interface web
      - PASSWORD=${PASSWORD}                   # Option alternative pour certains setups
      - WG_PORT=${WG_PORT}                     # Port WireGuard
      - WG_DEFAULT_ADDRESS=${WG_DEFAULT_ADDRESS} # Plage IP pour clients VPN (ex: 10.13.13.1/24)
      - WG_ALLOWED_IPS=${WG_ALLOWED_IPS}         # Plages autorisées pour le routage (ex: 0.0.0.0/0)
      - WG_DEFAULT_DNS=${WG_DEFAULT_DNS}         # DNS pour les clients VPN
      - WG_HOST=${WG_HOST}                       # Nom d'hôte ou IP publique pour le VPN
      - TZ=${TZ}                                 # Fuseau horaire (ex: Europe/Paris)

    # ---------------------------
    # Volumes
    # ---------------------------
    volumes:
      - ${WG_VOLUME_PATH}:/etc/wireguard        # Répertoire persistant pour configs WireGuard

    # ---------------------------
    # Capacités et sysctl
    # ---------------------------
    cap_add:
      - NET_ADMIN      # Nécessaire pour config réseau
      - SYS_MODULE     # Nécessaire pour certains modules kernel
    sysctls:
      - net.ipv4.ip_forward=1                   # Activer le forwarding IPv4
      - net.ipv6.conf.all.forwarding=1          # Activer le forwarding IPv6

    # ---------------------------
    # Réseau Docker
    # ---------------------------
    networks:
      - vpn_net

# ===========================
# Réseaux
# ===========================
networks:
  vpn_net:
    driver: bridge                             # Isolation du conteneur dans un bridge Docker privé
